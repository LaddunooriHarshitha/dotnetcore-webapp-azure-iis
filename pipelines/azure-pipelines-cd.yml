 trigger: none

stages:
- stage: Deploy
  displayName: 'Deploy to IIS VM'
  jobs:
  - job: InstallIIS
    displayName: 'Install IIS on Azure VM'
    pool:
      vmImage: 'windows-latest'
    steps:
    - checkout: self

    - task: PowerShell@2
      displayName: 'Run install-iis.ps1 via WinRM'
      inputs:
        targetType: 'inline'
        script: |
          $vmIp = "20.40.47.69"  # replace with your VM's public IP
          $username = "azureuser"
          $password = "Harshitha@2025"

          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ($username, $securePassword)

          # Add IP to TrustedHosts
          Set-Item WSMan:\localhost\Client\TrustedHosts -Value $vmIp -Force

          # Run remote IIS install
          Invoke-Command -ComputerName $vmIp -Port 5985 -UseSSL:$false -Credential $cred -ScriptBlock {
              Install-WindowsFeature -name Web-Server -IncludeManagementTools
              Install-WindowsFeature -name Web-Asp-Net45
              Set-ItemProperty "IIS:\AppPools\DefaultAppPool" -Name "managedRuntimeVersion" -Value "v4.0"
              Start-Service W3SVC
              Set-Service W3SVC -StartupType Automatic
              Write-Host "âœ… IIS and ASP.NET installed successfully."
          }
